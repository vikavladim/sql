# Project 01 ETL

ETL (Extract, Transform, Load) - это процесс извлечения данных из источника, их преобразования и загрузки в целевое
хранилище. Этот процесс используется для подготовки данных для анализа, визуализации или других операций.

## Содержание

1. [Упражнение 00 - Классическая DWH](#упражнение-00---классическая-dwh)
2. [Упражнение 01 - Детальный запрос](#упражнение-01--детальный-запрос)


- Запустите [script](materials/rush01_model.sql).

![schema](misc/images/schema.png)

## Упражнение 00 - Классическая DWH

| Задание 00: Классическая DWH |                   |
|------------------------------|-------------------|
| Каталог для сдачи            | ex00              |
| Файлы для сдачи              | `team01_ex00.sql` |
| **Разрешено**                |                   |
| Язык                         | SQL               |

Давайте рассмотрим источники данных и первый логический слой данных (ODS - Operational Data Store) в DWH.

![T01_05](misc/images/T01_05.png)

`User` таблица определения (в базе данных Green Source):

| Название столбца | Описание             |
|------------------|----------------------|
| ID               | Первичный ключ       |
| name             | Имя пользователя     |
| lastname         | Фамилия пользователя |

`Currency` таблица определения (в базе данных Red Source):

| Название столбца | Описание                 |
|------------------|--------------------------|
| ID               | Первичный ключ           |
| name             | Название валюты          |
| rate_to_usd      | Коэффициент к валюте USD |

`Balance` таблица определения (в базе данных Blue Source):

| Название столбца | Описание                                                             |
|------------------|----------------------------------------------------------------------|
| user_id          | “Виртуальный внешний ключ” к таблице `User` из другого источника     |
| money            | Сумма денег                                                          |
| type             | Тип баланса (может быть 0,1,...)                                     |
| currency_id      | “Виртуальный внешний ключ” к таблице `Currency` из другого источника |

Зеленые, красные и синие базы данных являются независимыми источниками данных и удовлетворяют шаблону микросервиса. Это
означает, что существует высокий риск аномалий данных (представленных ниже).

- Таблицы не находятся в согласованном состоянии данных. Это означает, что существует пользователь, но нет строк в
  таблице Balance, или наоборот, существует баланс, но нет строк в таблице User. Аналогичная ситуация между таблицами
  Currency и Balance. (другими словами, не существует явных внешних ключей между ними)
- Возможны значения NULL для name и lastname в таблице User
- Все таблицы работают под OLTP (OnLine Transactional Processing) SQL-трафиком. Это означает, что существует актуальное
  состояние данных в одно время, исторические изменения не сохраняются для каждой таблицы.

Эти три перечисленные таблицы являются источниками данных для таблиц с аналогичными моделями данных в области DWH.

`User` таблица определения (в базе данных DWH):

| Название столбца | Описание             |
|------------------|----------------------|
| ID               | Первичный ключ       |
| name             | Имя пользователя     |
| lastname         | Фамилия пользователя |

`Currency` таблица определения (в базе данных DWH):

| Название столбца | Описание                                       |
|------------------|------------------------------------------------|
| ID               | Поддельный первичный ключ                      |
| name             | Название валюты                                |
| rate_to_usd      | Коэффициент к валюте USD                       |
| updated          | Метка времени события из базы данных-источника |

`Поддельный первичный ключ` означает, что существуют дубликаты с одинаковым ID, поскольку был добавлен новый атрибут
updated, который преобразует нашу реляционную модель в темпоральный реляционную модель.

Пожалуйста, посмотрите на образец данных для валюты "EUR" ниже.
Этот образец основан на SQL-выражении

    SELECT *
    FROM Currency
    WHERE name = ‘EUR’
    ORDER BY updated DESC;

| ID  | name | rate_to_usd | updated          |
|-----|------|-------------|------------------|
| 100 | EUR  | 0.9         | 03.03.2022 13:31 |
| 100 | EUR  | 0.89        | 02.03.2022 12:31 |
| 100 | EUR  | 0.87        | 02.03.2022 08:00 |
| 100 | EUR  | 0.9         | 01.03.2022 15:36 |
| ... | ...  | ...         | ...              |

`Balance` таблица определения (в базе данных DWH):

| Column Name | Description                                               |
|-------------|-----------------------------------------------------------|
| user_id     | “Virtual Foreign Key” to User table from other source     |
| money       | Amount of money                                           |
| type        | Type of balance (can be 0,1,...)                          |
| currency_id | “Virtual Foreign Key” to Currency table from other source |
| updated     | Timestamp of event from source database                   |

Пожалуйста, посмотрите на образец данных ниже.
Этот образец основан на SQL-выражении

    SELECT *
    FROM Balance
    WHERE user_id = 103
    ORDER BY type, updated DESC;

| user_id | money | type | currency_id | updated          |
|---------|-------|------|-------------|------------------|
| 103     | 200   | 0    | 100         | 03.03.2022 12:31 |
| 103     | 150   | 0    | 100         | 02.03.2022 11:29 |
| 103     | 15    | 0    | 100         | 03.03.2022 08:00 |
| 103     | -100  | 1    | 102         | 01.03.2022 15:36 |
| 103     | 2000  | 1    | 102         | 12.12.2021 15:36 |
| ...     | ...   | ...  | ...         | ...              |

Все таблицы в DWH наследуют все аномалии от таблиц-источников.

- Таблицы не находятся в согласованном состоянии данных.
- Возможны значения NULL для name и lastname в таблице User

Пожалуйста, напишите SQL-выражение, которое возвращает общий объем (сумму всех денег) транзакций с баланса пользователя,
агрегированный по пользователю и типу баланса. Пожалуйста, обратите внимание, что все данные должны быть обработаны,
включая данные с аномалиями. Ниже представлена таблица столбцов вывода и соответствующих формул расчета.

| Столбец вывода      | Формула (псевдокод)                                                                                                                                   |
|---------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------|
| name                | источник: user.name если user.name является NULL, то вернуть значение `not defined`                                                                   |
| lastname            | источник: user.lastname если user.lastname является NULL, то вернуть значение `not defined`                                                           |
| type                | источник: balance.type                                                                                                                                | 
| volume              | источник: balance.money необходимо просуммировать все денежные "движения"                                                                             | 
| currency_name       | источник: currency.name если currency.name является NULL, то вернуть значение `not defined`                                                           | 
| last_rate_to_usd    | источник: currency.rate_to_usd. взять последний currency.rate_to_usd для соответствующей валюты если currency.rate_to_usd является NULL, то вернуть 1 | 
| total_volume_in_usd | источник: volume , last_rate_to_usd. произвести умножение между volume и last_rate_to_usd                                                             |

Пожалуйста, посмотрите на образец вывода данных ниже. Сортируйте результат по имени пользователя в порядке убывания, а
затем по фамилии пользователя и типу баланса в порядке возрастания.

| name | lastname    | type | volume | currency_name | last_rate_to_usd | total_volume_in_usd |
|------|-------------|------|--------|---------------|------------------|---------------------|
| Петр | not defined | 2    | 203    | not defined   | 1                | 203                 |
| Иван | Иванов      | 1    | 410    | EUR           | 0.9              | 369                 |
| ...  | ...         | ...  | ...    | ...           | ...              | ...                 |

# Упражнение 01 - Подробный запрос

| Задание 01: Подробный запрос |                   |
|------------------------------|-------------------|
| Папка для сдачи              | ex01              |
| Файлы для сдачи              | `team01_ex01.sql` |
| **Разрешенные**              |                   |
| Язык                         | ANSI SQL          |

Перед более глубоким погружением в эту задачу, пожалуйста, примените операторы INSERT ниже.

```sql
insert into currency
values (100, 'EUR', 0.85, '2022-01-01 13:29');
insert into currency
values (100, 'EUR', 0.79, '2022-01-08 13:29');
```

Пожалуйста, напишите SQL-оператор, который возвращает всех пользователей, все транзакции баланса (в этом задании
игнорируйте валюты, не имеющие ключа в таблице `Currency`) с названием валюты и рассчитанным значение валюты в
USD для ближайшего дня.

Ниже представлена таблица выходных столбцов и соответствующих формул расчета.

| Output Column   | Formula (pseudocode)                                                                                                                      |
|-----------------|-------------------------------------------------------------------------------------------------------------------------------------------|
| name            | source: user.name if user.name is NULL then return `not defined` value                                                                    |
| lastname        | source: user.lastname if user.lastname is NULL then return `not defined` value                                                            |
| currency_name   | source: currency.name                                                                                                                     | 
| currency_in_usd | involved sources: currency.rate_to_usd, currency.updated, balance.updated.Take a look at a graphical interpretation of the formula below. | 

![T01_06](misc/images/T01_06.png)

- нужно найти ближайший rate_to_usd валюты в прошлом (t1)
- если t1 пуст (значит, нет никаких ставок в прошлом), то найти ближайший rate_to_usd валюты в будущем (t2)
- использовать t1 или t2 ставку для расчета валюты в формате USD

Пожалуйста, посмотрите на образец выходных данных ниже. Сортируйте результат по имени пользователя в порядке убывания, а
затем по фамилии пользователя и названию валюты в порядке возрастания.

| name | lastname | currency_name | currency_in_usd |
|------|----------|---------------|-----------------|
| Иван | Иванов   | EUR           | 150.1           |
| Иван | Иванов   | EUR           | 17              |
| ...  | ...      | ...           | ...             |

